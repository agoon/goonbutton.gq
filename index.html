<!DOCTYPE html>
<html>
    <head>
        <title>Goon Button Game</title>
        <link rel="stylesheet" type="text/css" href="main.css"/>
        
        <script>
            (function() {
                var requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame || window.msRequestAnimationFrame;
                window.requestAnimationFrame = requestAnimationFrame;
            })();
            
            document.addEventListener('DOMContentLoaded', init);
            function init() {
                document.getElementById("theButton").addEventListener("click", theButtonClicked);
                document.addEventListener("keydown", function(e) {
                    if (e.keyCode == 65) {
                        keys.left = true;
                    }
                    
                    else if (e.keyCode == 68) {
                        keys.right = true;
                    }
                    
                    else if (e.keyCode == 87) {
                        keys.up = true;
                    }
                });
                document.addEventListener("keyup", function(e) {
                    if (e.keyCode == 65) {
                        keys.left = false;
                    }
                    
                    else if (e.keyCode == 68) {
                        keys.right = false;
                    }
                    
                    else if (e.keyCode == 87) {
                        keys.up = false;
                    }
                });
                window.addEventListener("load",function(){
                    update();
                });
                
                
                var canvas = document.getElementById("canvas"),
                ctx = canvas.getContext("2d"),
                width = 1500,
                height = 500,
                player = {
                    x : width/2,
                    y : height - 5,
                    width : 20,
                    height : 20,
                    speed: 6,
                    velX: 0,
                    velY: 0,
                    jumping: false
                },
                spikes = [],
                keys = {
                    up : false,
                    left: false,
                    right: false
                }
                friction = .9,
                gravity = 0.5,
                updates = 0,
                time = 0,
                cooldown = 30,
                score = 0,
                buttonPhase = 0,
                delay = 60;
                lose = true;
                
                canvas.width = width;
                canvas.height = height;
                
                function theButtonClicked() {
                    if (buttonPhase == 0) {
                        document.getElementById("gameArea").style.visibility = "visible";
                        document.getElementById("score").style.visibility = "visible";
                        document.getElementById("nextClear").style.visibility = "visible";
                        lose = false;
                        buttonPhase++;
                    }
                    
                    else if (buttonPhase == 1) {
                        if (cooldown == 0) {
                            // Clear canvas
                            ctx.clearRect(0, 0, width, height);
                            
                            // Remove all spikes
                            spikes = [];

                            // Redraw player
                            ctx.fillStyle = "#3371EC";
                            ctx.fillRect(player.x, player.y, player.width, player.height);
                            
                            // Reset cooldown and add delay for spikes to be added
                            cooldown = 30;
                            delay = 60;
                        }
                    }
                    
                    else if (buttonPhase == 2) {
                        // Reset score
                        document.getElementById("score").innerHTML = "Score: 0";
                        score = 0;
                        
                        // Reset next clear
                        document.getElementById("nextClear").innerHTML = "Next Clear: 30";
                        cooldown = 30;
                        delay = 60;
                        time = 0;
                        
                        // Clear canvas
                        ctx.clearRect(0, 0, width, height);
                            
                        // Remove all spikes
                        spikes = [];

                        // Reset player
                        player.x = width/2;
                        player.y = height - 5;
                        player.velX = 0;
                        player.velY = 0;
                        ctx.fillStyle = "#3371EC";
                        ctx.fillRect(player.x, player.y, player.width, player.height);
                        
                        // Restart game
                        buttonPhase = 1;
                        lose = false;
                    }
                }
                
                function update() {
                    if (!lose) {
                        // W is pressed
                        if (keys.up) {
                            // If player isn't already jumping, jump
                            if(!player.jumping) {
                                player.jumping = true;
                                player.velY = -player.speed*2;
                            }
                        }

                        // D is pressed
                        if (keys.right) {
                            // If velocity in x-direction is less than maximum speed, increase it
                            if (player.velX < player.speed) {             
                                player.velX++;         
                            }     
                        }     

                        // A is pressed
                        if (keys.left) {
                            // If velocity in x-direction is less than maximum speed, increase it
                            if (player.velX > -player.speed) {
                                player.velX--;
                            }
                        }

                        // Introduce friction so that player doesn't keep moving without more key presses
                        player.velX *= friction;

                        // Introduce gravity so that player falls after jumping
                        player.velY += gravity;

                        // Move player based on current velocity
                        player.x += player.velX;
                        player.y += player.velY;

                        // Don't let player go outside boundaries
                        if (player.x >= width-player.width) {
                            player.x = width-player.width;
                        }

                        else if (player.x <= 0) {         
                            player.x = 0;     
                        }    

                        // Check if player has landed
                        if(player.y >= height-player.height){
                            player.y = height - player.height;
                            player.velY = 0;
                            player.jumping = false;
                        }

                        // Add spikes if enough updates have passed or delay is not set
                        if (updates >= 3 && delay == 0) {
                            spikes.push({
                                x : 0,
                                y : 0,
                                width : 15,
                                height : 15,
                                speed : 1,
                                velX: 0,
                                velY: 0
                            });
                            spikes[spikes.length - 1].x = Math.random() * width;
                            spikes[spikes.length - 1].velY = (Math.random() + 1) * 3;
                            updates = 0;
                        }

                        // Move spikes based on current velocity
                        for(var i = 0; i < spikes.length; i++) {
                            spikes[i].x += spikes[i].velX;
                            spikes[i].y += spikes[i].velY;
                            
                            // Remove spike from array if it's past edge
                            if (spikes[i].y >= height) {
                                spikes.splice(i,1);
                                i--;
                                score++;
                                document.getElementById("score").innerHTML = "Score: " + score;
                            }
                            
                            // Check if spike intersect with player
                            else {
                                // Check top left corner and bottom left corner of spike
                                if (spikes[i].x >= player.x && spikes[i].x <= player.x + player.width) {
                                    if (spikes[i].y >= player.y && spikes[i].y <= player.y + player.height) {
                                        lose = true;
                                        buttonPhase++;
                                    }

                                    else if (spikes[i].y + spikes[i].height >= player.y && spikes[i].y + spikes[i].height <= player.y + player.height) {
                                        lose = true;
                                        buttonPhase++;
                                    }
                                }

                                // Check top right corner and bottom right corner of spike
                                else if (spikes[i].x + spikes[i].width >= player.x && spikes[i].x + spikes[i].width <= player.x + player.width) {
                                    if (spikes[i].y >= player.y && spikes[i].y <= player.y + player.height) {
                                        lose = true;
                                        buttonPhase++;
                                    }

                                    else if (spikes[i].y + spikes[i].height >= player.y && spikes[i].y + spikes[i].height <= player.y + player.height) {
                                        lose = true;
                                        buttonPhase++;
                                    }
                                }
                            }
                        }

                        // Clear canvas
                        ctx.clearRect(0, 0, width, height);

                        // Redraw player
                        ctx.fillStyle = "#3371EC";
                        ctx.fillRect(player.x, player.y, player.width, player.height);

                        // Redraw spikes
                        ctx.fillStyle = "red";
                        for(var i = 0; i < spikes.length; i++) {
                            ctx.fillRect(spikes[i].x, spikes[i].y, spikes[i].width, spikes[i].height);
                        }
                        
                        if (time >= 60) {
                            if (cooldown > 0) {
                                cooldown--;
                                document.getElementById("nextClear").innerHTML = "Next Clear: " + cooldown;
                            }
                            
                            time = 0;
                        }

                        updates++;
                        time++;
                        
                        if (delay > 0) {
                            delay--;
                        }
                    }
                    
                    // Call update again upon next animation frame
                    requestAnimationFrame(update);
                }
            }
        </script>
    </head>
    
    <body>
        <div class="main">
            <div id="gameArea">
                <canvas id="canvas"></canvas>
            </div>

            <div id="buttonArea">
                <div style="width: 33%; float:left">
                    <h1 id="score">Score: 0</h1>
                </div>
                <div style="width: 66%; float:right">
                    <div style="width: 50%; float:left">
                        <button class="button" id="theButton"></button>
                    </div>
                    
                    <div style="width: 50%; float:right">
                        <h1 id="nextClear">Next Clear: 30</h1>
                    </div>
                </div>
            </div>
        </div>
    </body>
    
    <script>
        
    </script>
</html>